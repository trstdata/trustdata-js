!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.AttributionCore=e():t.AttributionCore=e()}(this,(()=>(()=>{"use strict";var t={};const e=function(){return{page_location:document.location.href,page_referrer:document.referrer,page_title:document.title,language:(navigator&&(navigator.language||navigator.browserLanguage)||"").toLowerCase(),screen_resolution:(window.screen?window.screen.width:0)+"x"+(window.screen?window.screen.height:0)}},n=function(t){var e;return"node"===t||"undefined"==typeof window||"undefined"!=typeof window&&!("navigator"in window)?new Promise((function(t){t(null)})):null!==(e=navigator)&&void 0!==e&&null!==(e=e.userAgentData)&&void 0!==e&&e.getHighEntropyValues?navigator.userAgentData.getHighEntropyValues(["platform","platformVersion","architecture","model","uaFullVersion","bitness","fullVersionList","wow64"]).then((function(t){var e,n,r;return{user_agent_architecture:t.architecture,user_agent_bitness:t.bitness,user_agent_full_version_list:encodeURIComponent((Object.values(t.fullVersionList)||(null===(e=navigator)||void 0===e||null===(e=e.userAgentData)||void 0===e?void 0:e.brands)).map((function(t){return[t.brand,t.version].join(";")})).join("|")),user_agent_mobile:t.mobile?1:0,user_agent_model:t.model||(null===(n=navigator)||void 0===n||null===(n=n.userAgentData)||void 0===n?void 0:n.mobile),user_agent_platform:t.platform||(null===(r=navigator)||void 0===r||null===(r=r.userAgentData)||void 0===r?void 0:r.platform),user_agent_platform_version:t.platformVersion,user_agent_wow64:t.wow64?1:0}})):new Promise((function(t){t(null)}))};var r=function(){return Math.floor(1*new Date/1e3)},o=function(){var t;return"undefined"!=typeof window&&void 0!==window.document?t="browser":"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node&&(t="node"),t};const i={canUseStorage:function(t){return!0===t.analytics},cookies:{get:function(t,e){if(!e||"undefined"==typeof document)return null;for(var n=t+"=",r=document.cookie.split(";"),o=0;o<r.length;o++){for(var i=r[o];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(n))return decodeURIComponent(i.substring(n.length,i.length))}return null},set:function(t,e,n,r){if(r&&"undefined"!=typeof document){var o="";if(n){var i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),o="; expires="+i.toUTCString()}document.cookie=t+"="+encodeURIComponent(e)+o+"; path=/; SameSite=Lax"}},remove:function(t,e){e&&"undefined"!=typeof document&&(document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax")}},local:{get:function(t,e,n){if(!e)return null;try{return localStorage.getItem(t)}catch(t){return n&&console.warn("[Attribution Core] localStorage access error",t),null}},set:function(t,e,n,r){if(n)try{localStorage.setItem(t,e)}catch(t){r&&console.warn("[Attribution Core] localStorage set error",t)}},remove:function(t,e,n){if(e)try{localStorage.removeItem(t)}catch(t){n&&console.warn("[Attribution Core] localStorage remove error",t)}}},clearAllTracking:function(t){t&&(this.cookies.remove("_trdt_uat_cid",!0),this.cookies.remove("_trdt_uat_sid",!0),this.cookies.remove("_trdt_uat_last",!0),this.local.remove("_trdt_uat_cid",!0,!1),this.local.remove("_trdt_uat_snum",!0,!1),this.local.remove("_trdt_uat_uid",!0,!1),this.local.remove("_trdt_uat_offline",!0,!1))}},a=function(t,e,n){e.attributionIds.forEach((function(r){var o=Object.assign({},t);if(o.attribution_id=r,"undefined"!=typeof fetch)fetch(e.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),keepalive:!0}).catch((function(t){console.error("[Attribution Core] Failed to send event:",t),n(o)}));else{var i=new XMLHttpRequest;i.open("POST",e.endpoint,!0),i.setRequestHeader("Content-Type","application/json"),i.timeout=1e4,i.onreadystatechange=function(){4===i.readyState&&(i.status<200||i.status>=300)&&(console.error("[Attribution Core] Failed to send event, status:",i.status),n(o))},i.onerror=function(){console.error("[Attribution Core] XHR error when sending event"),n(o)},i.send(JSON.stringify(o))}}))},s=function(t,e){var n="msg_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9));navigator.serviceWorker.controller.postMessage({action:"recordEvent",endpoint:e.endpoint,payload:t,messageId:n,timestamp:Date.now()})},u=function(t,e){e.attributionIds.forEach((function(n){var r=Object.assign({},t);r.attribution_id=n,navigator.sendBeacon(e.endpoint,new Blob([JSON.stringify(r)],{type:"application/json"}))}))},c=function(t,e,n){if(!t.useServiceWorker||!e.consentStatus.analytics||void 0===navigator.serviceWorker)return!1;try{navigator.serviceWorker.register(t.swPath).then((function(e){t.debug&&console.log("[Attribution Core] Service Worker registered:",e),window.addEventListener("online",(function(){t.debug&&console.log("[Attribution Core] Online - processing offline events"),n()})),document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&(t.debug&&console.log("[Attribution Core] Page visible - processing offline events"),n())}))})).catch((function(t){console.error("[Attribution Core] Service Worker registration failed:",t)}))}catch(t){return console.error("[Attribution Core] Error registering Service Worker:",t),!1}return!0},l=function(){return"undefined"!=typeof navigator&&void 0!==navigator.serviceWorker&&null!==navigator.serviceWorker.controller};function d(t){return function(t){if(Array.isArray(t))return f(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return f(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}const g=function(t,e,n){var r=t.queue.slice();if(t.queue=[],r.forEach((function(t){var n=t.shift();e.apply(void 0,[n].concat(d(t)))})),n._trdt_uat_queue&&Array.isArray(n._trdt_uat_queue)){var o=n._trdt_uat_queue.slice();n._trdt_uat_queue=[],o.forEach((function(t){if(Array.isArray(t)){var n=t.shift();e.apply(void 0,[n].concat(d(t)))}}))}},v=function(t,e,n){if(t._trdt_uat_queue&&t._trdt_uat_queue.length>0){n&&console.log("[Attribution Core] Found existing queue with",t._trdt_uat_queue.length,"commands");var r=t._trdt_uat_queue.find((function(t){return"init"===t[0]}));r&&e.apply(void 0,d(r))}return!1},_=function(t,e){return t.queue.push(e),!0},p=function(t,e){return t._trdt_uat_queue=t._trdt_uat_queue||[],t._trdt_uat_queue.push(e),!0},m=function(t,e,n,r){if(e&&n)try{var o=JSON.parse(localStorage.getItem("_trdt_uat_offline")||"[]");o.push({payload:t,timestamp:Date.now()}),localStorage.setItem("_trdt_uat_offline",JSON.stringify(o)),r&&console.log("[Attribution Core] Saved event for offline processing")}catch(t){console.error("[Attribution Core] Failed to save event for offline processing",t)}},h=function(t,e,n,r){if(e&&n)try{var o=JSON.parse(localStorage.getItem("_trdt_uat_offline")||"[]");if(0===o.length)return;r&&console.log("[Attribution Core] Processing ".concat(o.length," offline events"));var i=[];o.forEach((function(e){try{fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.payload),keepalive:!0}).catch((function(){i.push(e)}))}catch(t){i.push(e)}})),localStorage.setItem("_trdt_uat_offline",JSON.stringify(i)),r&&console.log("[Attribution Core] Processed offline events, ".concat(i.length," remaining"))}catch(t){console.error("[Attribution Core] Error processing offline events",t)}};function b(t){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},b(t)}function y(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i,a,s=[],u=!0,c=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=i.call(n)).done)&&(s.push(r.value),s.length!==e);u=!0);}catch(t){c=!0,o=t}finally{try{if(!u&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(t,e)||function(t,e){if(t){if("string"==typeof t)return S(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?S(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}return function(t,d,f){t._trdt_uat=t._trdt_uat||{},t._trdt_uat_queue=t._trdt_uat_queue||[];var S={version:"1.1.0",debug:!1,endpoint:"https://t.trstdata.com/api/events",swPath:"https://cdn.jsdelivr.net/gh/trstdata/trustdata-js@main/dist/v1/core-sw-v1.js",useServiceWorker:"serviceWorker"in navigator,offlineStorage:!0,sessionTimeout:30,initialized:!1,attributionIds:null,instance:null},w={clientId:null,userId:null,sessionId:null,sessionNumber:1,sessionEngaged:!1,hitCount:0,consentStatus:{analytics:!1,advertising:!1,personalization:!1},persistentParameters:{},queue:[]},A={generateId:function(){return Math.floor(2147483648*Math.random()+0)+"."+r()},getTimestamp:function(){return r()},sanitize:function(t){var e,n,r,o=arguments.length>1&&arguments[1]!==f?arguments[1]:100;if(null===t||t===f)return t;if((e=t)&&("[object Function]"===Object.prototype.toString.call(e)||"function"==typeof e&&"[object RegExp]"!==Object.prototype.toString.call(e)))try{t=t()}catch(t){return S.debug&&console.error("Attribution Core: Error evaluating function parameter",t),null}return function(t){return null!=t&&"string"==typeof t}(t)?(r=o,"string"==typeof(n=t)?n.substring(0,r):n):t},log:function(){if(S.debug){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];(t=console).log.apply(t,["[Attribution Core]"].concat(n))}},error:function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];(t=console).error.apply(t,["[Attribution Core]"].concat(n))},serializeEvent:function(t){var r={};if(r.attribution_id=S.attributionIds,r.client_id=w.clientId,r.user_id=w.userId,r.session_id=w.sessionId,r.session_number=w.sessionNumber,r.session_engaged=w.sessionEngaged?1:0,r.hit_count=w.hitCount,r.event_time=A.getTimestamp(),void 0!==d){var i=e();Object.entries(i).forEach((function(t){var e=y(t,2),n=e[0],o=e[1];r[n]=o}))}var a=o();return"browser"===a&&(n(a).then((function(t){t&&Object.entries(t).forEach((function(t){var e=y(t,2),n=e[0],r=e[1];w.persistentParameters[n]=r}))})).catch((function(t){S.debug&&console.warn("[Attribution Core] Error collecting client hints:",t)})),["user_agent_architecture","user_agent_bitness","user_agent_full_version_list","user_agent_mobile","user_agent_model","user_agent_platform","user_agent_platform_version","user_agent_wow64"].forEach((function(t){w.persistentParameters[t]&&(r[t]=w.persistentParameters[t])}))),Object.entries(w.persistentParameters).forEach((function(t){var e=y(t,2),n=e[0],o=e[1];r[n]=o})),r.consent_analytics=w.consentStatus.analytics,r.consent_advertising=w.consentStatus.advertising,r.consent_personalization=w.consentStatus.personalization,t&&(t.event_name&&(r.event_name=t.event_name,delete t.event_name),Object.entries(t).forEach((function(t){var e=y(t,2),n=e[0],o=e[1];r[n]=o}))),r}},I={init:function(e){var r=arguments.length>1&&arguments[1]!==f?arguments[1]:{};if(e){S.attributionIds=Array.isArray(e)?e:[e],Object.assign(S,r),S.debug&&A.log("Initializing with IDs:",S.attributionIds);var a=i.canUseStorage(w.consentStatus),s=r.client_id||i.cookies.get("_trdt_uat_cid",a)||i.local.get("_trdt_uat_cid",a,S.debug);s?w.clientId=s:(w.clientId=A.generateId(),a&&(i.cookies.set("_trdt_uat_cid",w.clientId,365,a),i.local.set("_trdt_uat_cid",w.clientId,a,S.debug))),this.initSession();var u=o();return"browser"===u&&n(u).then((function(t){t&&(Object.entries(t).forEach((function(t){var e=y(t,2),n=e[0],r=e[1];w.persistentParameters[n]=r})),S.debug&&A.log("Collected client hints:",t))})).catch((function(t){S.debug&&console.warn("[Attribution Core] Error collecting client hints:",t)})),S.initialized=!0,g(w,this.command.bind(this),t),S.useServiceWorker&&w.consentStatus.analytics&&c(S,w,this.processOfflineEvents.bind(this)),!0}A.error("Initialization failed: Missing attribution IDs")},initSession:function(){var t=A.getTimestamp(),e=i.canUseStorage(w.consentStatus);if(e){w.sessionId=i.cookies.get("_trdt_uat_sid",e),w.sessionNumber=parseInt(i.local.get("_trdt_uat_snum",e,S.debug)||"1");var n=parseInt(i.cookies.get("_trdt_uat_last",e)||"0");!w.sessionId||t-n>60*S.sessionTimeout?(w.sessionId=t,w.sessionNumber++,w.sessionEngaged=!1,i.local.set("_trdt_uat_snum",w.sessionNumber.toString(),e,S.debug),i.cookies.set("_trdt_uat_sid",w.sessionId,0,e),i.cookies.set("_trdt_uat_last",t.toString(),0,e)):(w.sessionEngaged=!0,i.cookies.set("_trdt_uat_last",t.toString(),0,e))}else w.sessionId=t,w.sessionNumber=1,w.sessionEngaged=!1},command:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];if(S.initialized||"init"===t)switch(t){case"init":return this.init.apply(this,n);case"config":return this.config.apply(this,n);case"set":return this.set.apply(this,n);case"event":return this.event.apply(this,n);case"consent":return this.consent.apply(this,n);case"get":return this.get.apply(this,n);default:return A.error("Unknown command:",t),!1}else _(w,[t].concat(n))},config:function(t){var e=arguments.length>1&&arguments[1]!==f?arguments[1]:{};return t&&(S.attributionIds=Array.isArray(t)?t:[t]),Object.assign(S,e),A.log("Configuration updated:",S),!0},set:function(t,e){var n=this;if("object"===b(t))return Object.entries(t).forEach((function(t){var e=y(t,2),r=e[0],o=e[1];n.set(r,o)})),!0;e=A.sanitize(e);var r=i.canUseStorage(w.consentStatus);switch(t){case"user_id":w.userId=e,r&&i.local.set("_trdt_uat_uid",e,r,S.debug);break;case"client_id":w.clientId=e,r&&(i.cookies.set("_trdt_uat_cid",e,365,r),i.local.set("_trdt_uat_cid",e,r,S.debug));break;case"debug_mode":S.debug=!0===e||"true"===e;break;default:w.persistentParameters[t]=e}return A.log("Set ".concat(t,":"),e),!0},event:function(t){var e=arguments.length>1&&arguments[1]!==f?arguments[1]:{};if(!t)return A.error("Missing event name"),!1;w.sessionEngaged||(w.sessionEngaged=!0);var n=Object.assign({},e,{event_name:t}),r=A.serializeEvent(n);this.sendEvent(r);var o=i.canUseStorage(w.consentStatus);return o&&i.cookies.set("_trdt_uat_last",A.getTimestamp().toString(),0,o),w.hitCount++,A.log("Event sent:",t,r),!0},sendEvent:function(t){S.useServiceWorker&&l()&&w.consentStatus.analytics?s(t,S):a(t,S,this.saveOfflineEvent.bind(this))},saveOfflineEvent:function(t){var e=i.canUseStorage(w.consentStatus);m(t,e,S.offlineStorage,S.debug)},processOfflineEvents:function(){var t=i.canUseStorage(w.consentStatus);h(S.endpoint,t,S.offlineStorage,S.debug)},consent:function(t){if(!t||!t.hasOwnProperty("consent"))return A.error("Invalid consent parameters"),!1;var e=t.consent,n=Object.assign({},w.consentStatus),r=!1;return e.hasOwnProperty("analytics")&&n.analytics!==(!0===e.analytics)&&(w.consentStatus.analytics=!0===e.analytics,r=!0),e.hasOwnProperty("advertising")&&n.advertising!==(!0===e.advertising)&&(w.consentStatus.advertising=!0===e.advertising),e.hasOwnProperty("personalization")&&n.personalization!==(!0===e.personalization)&&(w.consentStatus.personalization=!0===e.personalization),(r||n.advertising!==w.consentStatus.advertising||n.personalization!==w.consentStatus.personalization)&&A.log("Consent updated:",w.consentStatus),r&&(w.consentStatus.analytics?(A.log("Analytics consent granted"),S.useServiceWorker&&c(S,w,this.processOfflineEvents.bind(this))):(A.log("Analytics consent withdrawn"),i.clearAllTracking(!0))),!0},get:function(t){switch(t){case"client_id":return w.clientId;case"user_id":return w.userId;case"session_id":return w.sessionId;case"hit_count":return w.hitCount;case"consent_status":return Object.assign({},w.consentStatus);case"debug_mode":return S.debug;default:return w.persistentParameters[t]}}};t._trdt_uat=Object.assign((function(){var e=Array.from(arguments);return 0===e.length?t._trdt_uat:"string"==typeof e[0]?I.command.apply(I,e):(A.error("Invalid attrib function call"),!1)}),I),t.attrib=t.attrib||function(){return S.initialized?t._trdt_uat.apply(null,arguments):(p(t,Array.from(arguments)),!0)},t._trdt_uat_queue.length>0&&(A.log("Found existing queue with",t._trdt_uat_queue.length,"commands"),v(t,I.command.bind(I),S.debug)),void 0!==d&&void 0!==t&&(t.addEventListener("online",(function(){S.initialized&&i.canUseStorage(w.consentStatus)&&I.processOfflineEvents()})),d.addEventListener("visibilitychange",(function(){"visible"===d.visibilityState&&S.initialized&&i.canUseStorage(w.consentStatus)&&I.processOfflineEvents()})),t.addEventListener("beforeunload",(function(){"function"==typeof navigator.sendBeacon&&w.queue.length>0&&S.initialized&&w.queue.forEach((function(t){if("event"===t[0]){var e=t[1],n=t[2]||{},r=Object.assign({},n,{event_name:e}),o=A.serializeEvent(r);u(o,S)}}))})))}(window,document),t.default})()));