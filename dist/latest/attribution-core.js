!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AttributionCore=t():e.AttributionCore=t()}(this,(()=>(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>u});const o=(e,t)=>"string"==typeof e?e.substring(0,t):e,n=()=>Math.floor(2147483648*Math.random()+0),a=()=>Math.floor(1*new Date/1e3),s=()=>{let e;return"undefined"!=typeof window&&void 0!==window.document?e="browser":"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node&&(e="node"),e},r=(e,t)=>{try{e=e.toString()}catch(e){}return(e=>null!=e&&"string"==typeof e)(e)&&t&&(e=>"number"==typeof e&&!isNaN(e))(t)?o(e,t):e},i=(e,t,o="browser",n={})=>{return new URLSearchParams(JSON.parse(JSON.stringify(t))).toString(),function(){console.log("Trying direct fetch");try{return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"omit",keepalive:!0,mode:"no-cors"}).then((()=>{console.log("Fetch completed successfully")})).catch((e=>{console.log("Fetch failed:",e),a()})),!0}catch(e){return console.log("Fetch threw an error:",e),a()}}();function a(){try{const o=e.replace("analytics.","api.").replace("track.","app.");return fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,recovery:!0}),credentials:"omit",keepalive:!0,mode:"no-cors"}).then((()=>(console.log("Alternative domain fetch completed"),!0))).catch((e=>(console.log("Alternative domain fetch failed:",e),!1))),!0}catch(e){return console.log("Alternative fetch error:",e),!1}}},c="1.0.5",l={cookies:{set:function(e,t,o,n){if("undefined"==typeof document||!n)return;let a="";if(o){const e=new Date;e.setTime(e.getTime()+24*o*60*60*1e3),a="; expires="+e.toUTCString()}document.cookie=e+"="+encodeURIComponent(t)+a+"; path=/; SameSite=Lax"},get:function(e,t){if("undefined"==typeof document||!t)return null;const o=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){let t=n[e];for(;" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(o))return decodeURIComponent(t.substring(o.length,t.length))}return null},delete:function(e,t){t&&this.set(e,"",-1,!0)}},localStorage:{set:function(e,t,o){if(o)try{"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}catch(e){console.warn("localStorage access denied:",e)}},get:function(e,t){if(!t)return null;try{if("undefined"!=typeof localStorage)return localStorage.getItem(e)}catch(e){console.warn("localStorage access denied:",e)}return null}},getClientId:function(e){let t=e?this.cookies.get("_attrib_cid",!0):null;return!t&&e&&(t=this.localStorage.get("_attrib_cid",!0)),t||(t=[n(),a()].join("."),e&&(this.cookies.set("_attrib_cid",t,365,!0),this.localStorage.set("_attrib_cid",t,!0))),t},getSessionData:function(e=30,t){const o=a();let n,s,r,i;return t?(n=this.cookies.get("_attrib_sid",!0),s=parseInt(this.localStorage.get("_attrib_snum",!0)||"0"),r=parseInt(this.cookies.get("_attrib_last",!0)||"0"),i=!n||o-r>60*e,i&&(n=o,s++,this.localStorage.set("_attrib_snum",s.toString(),!0)),this.cookies.set("_attrib_sid",n,0,!0),this.cookies.set("_attrib_last",o.toString(),0,!0)):(n=o,s=1,i=!0),{id:n,number:s,isNew:i}}},d={ConsentTypes:{ANALYTICS:"analytics",MARKETING:"marketing",ADVERTISING:"advertising",PERSONALIZATION:"personalization",NECESSARY:"necessary"},getConsentStatus:function(){return Promise.resolve({hasConsent:{analytics:!1,marketing:!1,advertising:!1,personalization:!1},framework:"custom",gdprApplies:!1,ccpaApplies:!1,ccpaOptOut:!1,timestamp:Date.now()})}},g={swRegistration:null,register:function(e="../dist/latest/core-sw.js",t){return t&&"serviceWorker"in navigator?navigator.serviceWorker.register(e).then((e=>(this.swRegistration=e,console.debug("Service Worker registered successfully",e),e))).catch((e=>(console.error("Service Worker registration failed:",e),null))):(console.warn("Service Workers not registered: consent not given or not supported"),Promise.resolve(null))},sendMessage:function(e){return new Promise(((t,o)=>{if(!this.swRegistration||!navigator.serviceWorker.controller)return void t({error:"Service worker not active",fallback:!0});const n=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;e.messageId=n;const a=e=>{e.data&&e.data.messageId===n&&(navigator.serviceWorker.removeEventListener("message",a),t(e.data))};navigator.serviceWorker.addEventListener("message",a),navigator.serviceWorker.controller.postMessage(e),setTimeout((()=>{navigator.serviceWorker.removeEventListener("message",a),t({error:"Service worker response timeout",fallback:!0})}),3e3)}))},recordEvent:function(e,t){return this.sendMessage({action:"recordEvent",endpoint:e,payload:t,timestamp:Date.now()})}},u=function(e,t={}){if(!e)throw"Attribution core initialization aborted: missing attribution ids";const u=Object.assign({version:c,debug:!1,mode:s()||"browser",attribution_ids:null,queueDispatchTime:5e3,queueDispatchMaxEvents:10,queue:[],eventParameters:{},persistentEventParameters:{},user_agent:`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 [AttributionCore/${c}]`,user_ip_address:null,hooks:{beforeLoad:()=>{},beforeRequestSend:()=>{}},endpoint:"http://localhost/suivi",payloadData:{},useServiceWorker:!1!==t.useServiceWorker&&"serviceWorker"in navigator,swPath:t.swPath||"../dist/latest/core-sw.js",offlineStorage:!1!==t.offlineStorage,offlineStorageKey:t.offlineStorageKey||"attribution_core_events",recordConsent:!1!==t.recordConsent,requireConsent:!1,consentTypes:t.consentTypes||["analytics"],consentStatus:{hasConsent:{analytics:!1,marketing:!1,advertising:!1,personalization:!1},framework:"unknown",gdprApplies:!1,ccpaApplies:!1,ccpaOptOut:!1},sessionTimeout:t.sessionTimeout||30},t);let p=Promise.resolve(u.consentStatus),f=Promise.resolve(null);u.recordConsent&&"browser"===u.mode&&(p=d.getConsentStatus().then((e=>(u.consentStatus=e,S("consent_analytics",e.hasConsent.analytics),S("consent_marketing",e.hasConsent.marketing),S("consent_advertising",e.hasConsent.advertising),S("consent_framework",e.framework),e.gdprApplies&&S("gdpr_applies",!0),e.ccpaApplies&&(S("ccpa_applies",!0),S("ccpa_opt_out",e.ccpaOptOut)),e)))),p.then((s=>{const r=_(s);u.hasStorageConsent=r;const i=t.client_id||("browser"===u.mode?l.getClientId(r):[n(),a()].join("."));let d=t.session_id,p=t.session_number||1,S=!0;if("browser"===u.mode&&!t.session_id){const e=l.getSessionData(u.sessionTimeout,r);d=e.id,p=e.number,S=e.isNew}if(u.payloadData.attribution_id=Array.isArray(e)?e:[e],u.payloadData.client_id=i,u.payloadData.is_debug=t.debug?1:void 0,u.payloadData.non_personalized_ads=1,u.payloadData.hit_count=1,u.payloadData.session_id=d||a(),u.payloadData.session_number=p,u.payloadData.session_engaged=S?0:1,u.payloadData.user_id=t.user_id?o(t.user_id,256):void 0,u.payloadData.user_ip_address=t.user_ip_address?t.user_ip_address:void 0,u.userAgent=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 [AttributionCore/${c}]`,"node"===u.mode&&t.user_agent&&(u.user_agent=t.user_agent),"browser"===u.mode){const e={page_location:document.location.href,page_referrer:document.referrer,page_title:document.title,language:(navigator&&(navigator.language||navigator.browserLanguage)||"").toLowerCase(),screen_resolution:(window.screen?window.screen.width:0)+"x"+(window.screen?window.screen.height:0)};e&&(u.payloadData=Object.assign(u.payloadData,e)),u.useServiceWorker&&r&&(f=g.register(u.swPath,r)),u.offlineStorage&&r&&"addEventListener"in window&&(window.addEventListener("online",h),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&h()})),window.addEventListener("beforeunload",(()=>{if(u.queue.length>0)for(const e of u.queue)m(e.eventName,e.eventParameters,u.endpoint,e.payload)})))}}));const _=e=>!0===e.hasConsent.analytics,m=(e,t,o,n)=>{if(u.offlineStorage&&"browser"===u.mode&&u.hasStorageConsent)try{const a=JSON.parse(localStorage.getItem(u.offlineStorageKey)||"[]");a.push({eventName:e,eventParameters:t,endpoint:o,payload:n,timestamp:Date.now()}),localStorage.setItem(u.offlineStorageKey,JSON.stringify(a))}catch(e){console.error("Failed to save event to offline storage",e)}},h=()=>{if(u.offlineStorage&&"browser"===u.mode&&u.hasStorageConsent)try{const e=JSON.parse(localStorage.getItem(u.offlineStorageKey)||"[]");if(0===e.length)return;const t=[];for(const o of e)for(let e=0;e<o.payload.attribution_id.length;e++){let n=JSON.parse(JSON.stringify(o.payload));n.attribution_id=o.payload.attribution_id[e];try{i(o.endpoint,n,u.mode,{user_agent:u?.user_agent})}catch(e){t.push(o);break}}localStorage.setItem(u.offlineStorageKey,JSON.stringify(t))}catch(e){console.error("Failed to process offline events",e)}},S=(e,t)=>{if((o=t)&&("[object Function]"===Object.prototype.toString.call(o)||"function"==typeof o&&"[object RegExp]"!==Object.prototype.toString.call(o)))try{t=t()}catch(e){console.error("Error evaluating function parameter",e)}var o;e=r(e,40),t=r(t,100),u.persistentEventParameters[e]=t};return{version:u.version,mode:u.mode,getHitIndex:()=>u.payloadData.hit_count,getSessionId:()=>u.payloadData.session_id,getClientId:()=>u.payloadData.client_id,setEventsParameter:S,setUserId:e=>{if(u.payloadData.user_id=r(e,256),"browser"===u.mode&&u.hasStorageConsent)try{l.localStorage.set("_attrib_uid",e,!0)}catch(e){}},recordEvent:(e,t={},o={},n=!0)=>{var s;u.hasStorageConsent&&(()=>{if("browser"!==u.mode||!u.hasStorageConsent)return;const e=a();l.cookies.set("_attrib_last",e.toString(),0,!0)})(),Promise.all([(s=u?.mode,"node"===s||"undefined"==typeof window||"undefined"!=typeof window&&!("navigator"in window)?new Promise((e=>{e(null)})):navigator?.userAgentData?.getHighEntropyValues?navigator.userAgentData.getHighEntropyValues(["platform","platformVersion","architecture","model","uaFullVersion","bitness","fullVersionList","wow64"]).then((e=>({user_agent_architecture:e.architecture,user_agent_bitness:e.bitness,user_agent_full_version_list:encodeURIComponent((Object.values(e.fullVersionList)||navigator?.userAgentData?.brands).map((e=>[e.brand,e.version].join(";"))).join("|")),user_agent_mobile:e.mobile?1:0,user_agent_model:e.model||navigator?.userAgentData?.mobile,user_agent_platform:e.platform||navigator?.userAgentData?.platform,user_agent_platform_version:e.platformVersion,user_agent_wow64:e.wow64?1:0}))):new Promise((e=>{e(null)}))),p,f]).then((([a])=>{a&&(u.payloadData=Object.assign(u.payloadData,a));const s=((e,t)=>{const o=JSON.parse(JSON.stringify(u.payloadData));1!==o.hit_count||o.session_engaged||(o.session_engaged=1);const n=Object.assign(JSON.parse(JSON.stringify(u.persistentEventParameters)),JSON.parse(JSON.stringify(t)));return n.event_name=e,Object.entries(n).forEach((([e,t])=>{o[e]=t})),o})(e,t);if(s&&n){function r(o){for(let n=0;n<o.attribution_id.length;n++){let a=JSON.parse(JSON.stringify(o));a.attribution_id=o.attribution_id[n];try{i(u.endpoint,a,u.mode,{user_agent:u?.user_agent})}catch(n){u.offlineStorage&&"browser"===u.mode&&u.hasStorageConsent&&m(e,t,u.endpoint,o)}}u.payloadData.hit_count++}u.useServiceWorker&&g.swRegistration&&u.hasStorageConsent?g.recordEvent(u.endpoint,s).then((e=>{e.error||e.fallback?r(s):u.payloadData.hit_count++})).catch((()=>{r(s)})):r(s)}else u.queue.push({eventName:e,eventParameters:t,sessionControl:o,payload:s})>=u.queueDispatchMaxEvents&&(u.hasStorageConsent&&h(),u.queue=[])}))},createNewSession:()=>{const e=a();if("browser"===u.mode&&u.hasStorageConsent){let t=parseInt(l.localStorage.get("_attrib_snum",!0)||"1");t++,l.localStorage.set("_attrib_snum",t.toString(),!0),l.cookies.set("_attrib_sid",e.toString(),0,!0),l.cookies.set("_attrib_last",e.toString(),0,!0),u.payloadData.session_number=t}else u.payloadData.session_number=1;u.payloadData.session_id=e,u.payloadData.session_engaged=0},isServiceWorkerActive:()=>!!g.swRegistration,storage:{getItem:e=>"browser"===u.mode&&u.hasStorageConsent?l.localStorage.get(e,!0)||l.cookies.get(e,!0):null,setItem:(e,t,o=!0)=>{"browser"===u.mode&&u.hasStorageConsent&&(l.localStorage.set(e,t,!0),o&&l.cookies.set(e,t,365,!0))}},getConsentStatus:()=>Object.assign({},u.consentStatus),hasConsent:e=>!0===u.consentStatus.hasConsent[e],updateConsentStatus:e=>{if(!e)return;const t=u.hasStorageConsent;u.consentStatus=Object.assign({},u.consentStatus,e),u.hasStorageConsent=_(u.consentStatus),e.hasConsent&&(void 0!==e.hasConsent.analytics&&S("consent_analytics",e.hasConsent.analytics),void 0!==e.hasConsent.marketing&&S("consent_marketing",e.hasConsent.marketing),void 0!==e.hasConsent.advertising&&S("consent_advertising",e.hasConsent.advertising),void 0!==e.hasConsent.personalization&&S("consent_personalization",e.hasConsent.personalization)),e.framework&&S("consent_framework",e.framework),void 0!==e.gdprApplies&&S("gdpr_applies",e.gdprApplies),void 0!==e.ccpaApplies&&(S("ccpa_applies",e.ccpaApplies),void 0!==e.ccpaOptOut&&S("ccpa_opt_out",e.ccpaOptOut)),u.payloadData.non_personalized_ads=u.hasStorageConsent?0:1,!t&&u.hasStorageConsent&&"browser"===u.mode&&(u.payloadData.client_id&&(l.cookies.set("_attrib_cid",u.payloadData.client_id,365,!0),l.localStorage.set("_attrib_cid",u.payloadData.client_id,!0)),l.cookies.set("_attrib_sid",u.payloadData.session_id,0,!0),l.cookies.set("_attrib_last",a().toString(),0,!0),l.localStorage.set("_attrib_snum",u.payloadData.session_number.toString(),!0),u.payloadData.user_id&&l.localStorage.set("_attrib_uid",u.payloadData.user_id,!0),u.useServiceWorker&&(f=g.register(u.swPath,!0)),u.offlineStorage&&"addEventListener"in window&&(window.addEventListener("online",h),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&h()})),window.addEventListener("beforeunload",(()=>{if(u.queue.length>0)for(const e of u.queue)m(e.eventName,e.eventParameters,u.endpoint,e.payload)})))),t&&!u.hasStorageConsent&&"browser"===u.mode&&(l.cookies.delete("_attrib_cid"),l.cookies.delete("_attrib_sid"),l.cookies.delete("_attrib_last"))},hasStorageConsent:()=>u.hasStorageConsent,ConsentTypes:d.ConsentTypes}};return t.default})()));