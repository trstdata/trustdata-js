!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AttributionCore=t():e.AttributionCore=t()}(this,(()=>(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>m});const o=(e,t)=>"string"==typeof e?e.substring(0,t):e,n=()=>Math.floor(2147483648*Math.random()+0),r=()=>Math.floor(1*new Date/1e3),a=()=>{let e;return"undefined"!=typeof window&&void 0!==window.document?e="browser":"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node&&(e="node"),e},s=(e,t)=>{try{e=e.toString()}catch(e){}return(e=>null!=e&&"string"==typeof e)(e)&&t&&(e=>"number"==typeof e&&!isNaN(e))(t)?o(e,t):e},i=(e,t,o="browser",n={})=>{new URLSearchParams(JSON.parse(JSON.stringify(t))).toString();return function(){console.log("Trying direct fetch");try{return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"omit",keepalive:!0,mode:"no-cors"}).then((()=>{console.log("Fetch completed successfully")})).catch((e=>{console.log("Fetch failed:",e),r()})),!0}catch(e){return console.log("Fetch threw an error:",e),r()}}();function r(){try{const o=e.replace("analytics.","api.").replace("track.","app.");return fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,recovery:!0}),credentials:"omit",keepalive:!0,mode:"no-cors"}).then((()=>(console.log("Alternative domain fetch completed"),!0))).catch((e=>(console.log("Alternative domain fetch failed:",e),!1))),!0}catch(e){return console.log("Alternative fetch error:",e),!1}}},l=e=>"node"===e||"undefined"==typeof window||"undefined"!=typeof window&&!("navigator"in window)?new Promise((e=>{e(null)})):navigator?.userAgentData?.getHighEntropyValues?navigator.userAgentData.getHighEntropyValues(["platform","platformVersion","architecture","model","uaFullVersion","bitness","fullVersionList","wow64"]).then((e=>({user_agent_architecture:e.architecture,user_agent_bitness:e.bitness,user_agent_full_version_list:encodeURIComponent((Object.values(e.fullVersionList)||navigator?.userAgentData?.brands).map((e=>[e.brand,e.version].join(";"))).join("|")),user_agent_mobile:e.mobile?1:0,user_agent_model:e.model||navigator?.userAgentData?.mobile,user_agent_platform:e.platform||navigator?.userAgentData?.platform,user_agent_platform_version:e.platformVersion,user_agent_wow64:e.wow64?1:0}))):new Promise((e=>{e(null)})),c=()=>({page_location:document.location.href,page_referrer:document.referrer,page_title:document.title,language:(navigator&&(navigator.language||navigator.browserLanguage)||"").toLowerCase(),screen_resolution:(window.screen?window.screen.width:0)+"x"+(window.screen?window.screen.height:0)}),d="1.0.5",u={cookies:{set:function(e,t,o,n){if("undefined"==typeof document||!n)return;let r="";if(o){const e=new Date;e.setTime(e.getTime()+24*o*60*60*1e3),r="; expires="+e.toUTCString()}document.cookie=e+"="+encodeURIComponent(t)+r+"; path=/; SameSite=Lax"},get:function(e,t){if("undefined"==typeof document||!t)return null;const o=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){let t=n[e];for(;" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(o))return decodeURIComponent(t.substring(o.length,t.length))}return null},delete:function(e,t){t&&this.set(e,"",-1,!0)}},localStorage:{set:function(e,t,o){if(o)try{"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}catch(e){console.warn("localStorage access denied:",e)}},get:function(e,t){if(!t)return null;try{if("undefined"!=typeof localStorage)return localStorage.getItem(e)}catch(e){console.warn("localStorage access denied:",e)}return null}},getClientId:function(e){let t=e?this.cookies.get("_attrib_cid",!0):null;return!t&&e&&(t=this.localStorage.get("_attrib_cid",!0)),t||(t=[n(),r()].join("."),e&&(this.cookies.set("_attrib_cid",t,365,!0),this.localStorage.set("_attrib_cid",t,!0))),t},getSessionData:function(e=30,t){const o=r();let n,a,s,i;return t?(n=this.cookies.get("_attrib_sid",!0),a=parseInt(this.localStorage.get("_attrib_snum",!0)||"0"),s=parseInt(this.cookies.get("_attrib_last",!0)||"0"),i=!n||o-s>60*e,i&&(n=o,a++,this.localStorage.set("_attrib_snum",a.toString(),!0)),this.cookies.set("_attrib_sid",n,0,!0),this.cookies.set("_attrib_last",o.toString(),0,!0)):(n=o,a=1,i=!0),{id:n,number:a,isNew:i}}},g={ConsentTypes:{ANALYTICS:"analytics",ADVERTISING:"advertising",PERSONALIZATION:"personalization",NECESSARY:"necessary"},getConsentStatus:function(){return Promise.resolve({hasConsent:{analytics:!1,advertising:!1,personalization:!1},framework:"custom",gdprApplies:!1,timestamp:Date.now()})}},p={swRegistration:null,register:function(e="https://cdn.jsdelivr.net/gh/trstdata/trustdata-js@main/dist/v1/core-sw-v1.js",t){return t&&"serviceWorker"in navigator?navigator.serviceWorker.register(e).then((e=>(this.swRegistration=e,console.debug("Service Worker registered successfully",e),e))).catch((e=>(console.error("Service Worker registration failed:",e),null))):(console.warn("Service Workers not registered: consent not given or not supported"),Promise.resolve(null))},sendMessage:function(e){return new Promise(((t,o)=>{if(!this.swRegistration||!navigator.serviceWorker.controller)return void t({error:"Service worker not active",fallback:!0});const n=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;e.messageId=n;const r=e=>{e.data&&e.data.messageId===n&&(navigator.serviceWorker.removeEventListener("message",r),t(e.data))};navigator.serviceWorker.addEventListener("message",r),navigator.serviceWorker.controller.postMessage(e),setTimeout((()=>{navigator.serviceWorker.removeEventListener("message",r),t({error:"Service worker response timeout",fallback:!0})}),3e3)}))},recordEvent:function(e,t){return this.sendMessage({action:"recordEvent",endpoint:e,payload:t,timestamp:Date.now()})}},f=function(e,t={}){if(!e)throw"Attribution core initialization aborted: missing attribution ids";const f=Object.assign({version:d,debug:!1,mode:a()||"browser",attribution_ids:null,queueDispatchTime:5e3,queueDispatchMaxEvents:10,queue:[],eventParameters:{},persistentEventParameters:{},user_agent:`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 [AttributionCore/${d}]`,user_ip_address:null,hooks:{beforeLoad:()=>{},beforeRequestSend:()=>{}},endpoint:"https://t.trstdata.com/api/events",payloadData:{},useServiceWorker:!1!==t.useServiceWorker&&"serviceWorker"in navigator,swPath:t.swPath||"../dist/latest/core-sw.js",offlineStorage:!1!==t.offlineStorage,offlineStorageKey:t.offlineStorageKey||"attribution_core_events",recordConsent:!1!==t.recordConsent,requireConsent:!1,consentTypes:t.consentTypes||["analytics"],consentStatus:{hasConsent:{analytics:!1,advertising:!1,personalization:!1},framework:"unknown",gdprApplies:!1},sessionTimeout:t.sessionTimeout||30},t);let _=Promise.resolve(f.consentStatus),m=Promise.resolve(null);f.recordConsent&&"browser"===f.mode&&(_=g.getConsentStatus().then((e=>(f.consentStatus=e,w("consent_analytics",e.hasConsent.analytics),w("consent_advertising",e.hasConsent.advertising),w("consent_framework",e.framework),e.gdprApplies&&w("gdpr_applies",!0),e)))),_.then((a=>{const s=h(a);f.hasStorageConsent=s;const i=t.client_id||("browser"===f.mode?u.getClientId(s):[n(),r()].join("."));let l=t.session_id,g=t.session_number||1,_=!0;if("browser"===f.mode&&!t.session_id){const e=u.getSessionData(f.sessionTimeout,s);l=e.id,g=e.number,_=e.isNew}if(f.payloadData.attribution_id=Array.isArray(e)?e:[e],f.payloadData.client_id=i,f.payloadData.is_debug=t.debug?1:void 0,f.payloadData.non_personalized_ads=1,f.payloadData.hit_count=1,f.payloadData.session_id=l||r(),f.payloadData.session_number=g,f.payloadData.session_engaged=_?0:1,f.payloadData.user_id=t.user_id?o(t.user_id,256):void 0,f.payloadData.user_ip_address=t.user_ip_address?t.user_ip_address:void 0,f.userAgent=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 [AttributionCore/${d}]`,"node"===f.mode&&t.user_agent&&(f.user_agent=t.user_agent),"browser"===f.mode){const e=c();e&&(f.payloadData=Object.assign(f.payloadData,e)),f.useServiceWorker&&s&&(m=p.register(f.swPath,s)),f.offlineStorage&&s&&"addEventListener"in window&&(window.addEventListener("online",b),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&b()})),window.addEventListener("beforeunload",(()=>{if(f.queue.length>0)for(const e of f.queue)y(e.eventName,e.eventParameters,f.endpoint,e.payload)})))}}));const h=e=>!0===e.hasConsent.analytics,y=(e,t,o,n)=>{if(f.offlineStorage&&"browser"===f.mode&&f.hasStorageConsent)try{const r=JSON.parse(localStorage.getItem(f.offlineStorageKey)||"[]");r.push({eventName:e,eventParameters:t,endpoint:o,payload:n,timestamp:Date.now()}),localStorage.setItem(f.offlineStorageKey,JSON.stringify(r))}catch(e){console.error("Failed to save event to offline storage",e)}},b=()=>{if(f.offlineStorage&&"browser"===f.mode&&f.hasStorageConsent)try{const e=JSON.parse(localStorage.getItem(f.offlineStorageKey)||"[]");if(0===e.length)return;const t=[];for(const o of e)for(let e=0;e<o.payload.attribution_id.length;e++){let n=JSON.parse(JSON.stringify(o.payload));n.attribution_id=o.payload.attribution_id[e];try{i(o.endpoint,n,f.mode,{user_agent:f?.user_agent})}catch(e){t.push(o);break}}localStorage.setItem(f.offlineStorageKey,JSON.stringify(t))}catch(e){console.error("Failed to process offline events",e)}},w=(e,t)=>{if((o=t)&&("[object Function]"===Object.prototype.toString.call(o)||"function"==typeof o&&"[object RegExp]"!==Object.prototype.toString.call(o)))try{t=t()}catch(e){console.error("Error evaluating function parameter",e)}var o;e=s(e,40),t=s(t,100),f.persistentEventParameters[e]=t},S={version:f.version,mode:f.mode,getHitIndex:()=>f.payloadData.hit_count,getSessionId:()=>f.payloadData.session_id,getClientId:()=>f.payloadData.client_id,setEventsParameter:w,setUserId:e=>{if(f.payloadData.user_id=s(e,256),"browser"===f.mode&&f.hasStorageConsent)try{u.localStorage.set("_attrib_uid",e,!0)}catch(e){}},recordEvent:(e,t={},o={},n=!0)=>{f.hasStorageConsent&&(()=>{if("browser"!==f.mode||!f.hasStorageConsent)return;const e=r();u.cookies.set("_attrib_last",e.toString(),0,!0)})(),Promise.all([l(f?.mode),_,m]).then((([r])=>{r&&(f.payloadData=Object.assign(f.payloadData,r));const a=((e,t)=>{const o=JSON.parse(JSON.stringify(f.payloadData));1!==o.hit_count||o.session_engaged||(o.session_engaged=1);const n=Object.assign(JSON.parse(JSON.stringify(f.persistentEventParameters)),JSON.parse(JSON.stringify(t)));return n.event_name=e,Object.entries(n).forEach((([e,t])=>{o[e]=t})),o})(e,t);if(a&&n){function s(o){for(let n=0;n<o.attribution_id.length;n++){let r=JSON.parse(JSON.stringify(o));r.attribution_id=o.attribution_id[n];try{i(f.endpoint,r,f.mode,{user_agent:f?.user_agent})}catch(n){f.offlineStorage&&"browser"===f.mode&&f.hasStorageConsent&&y(e,t,f.endpoint,o)}}f.payloadData.hit_count++}f.useServiceWorker&&p.swRegistration&&f.hasStorageConsent?p.recordEvent(f.endpoint,a).then((e=>{e.error||e.fallback?s(a):f.payloadData.hit_count++})).catch((()=>{s(a)})):s(a)}else{f.queue.push({eventName:e,eventParameters:t,sessionControl:o,payload:a})>=f.queueDispatchMaxEvents&&(f.hasStorageConsent&&b(),f.queue=[])}}))},createNewSession:()=>{const e=r();if("browser"===f.mode&&f.hasStorageConsent){let t=parseInt(u.localStorage.get("_attrib_snum",!0)||"1");t++,u.localStorage.set("_attrib_snum",t.toString(),!0),u.cookies.set("_attrib_sid",e.toString(),0,!0),u.cookies.set("_attrib_last",e.toString(),0,!0),f.payloadData.session_number=t}else f.payloadData.session_number=1;f.payloadData.session_id=e,f.payloadData.session_engaged=0},isServiceWorkerActive:()=>!!p.swRegistration,storage:{getItem:e=>"browser"===f.mode&&f.hasStorageConsent?u.localStorage.get(e,!0)||u.cookies.get(e,!0):null,setItem:(e,t,o=!0)=>{"browser"===f.mode&&f.hasStorageConsent&&(u.localStorage.set(e,t,!0),o&&u.cookies.set(e,t,365,!0))}},getConsentStatus:()=>Object.assign({},f.consentStatus),hasConsent:e=>!0===f.consentStatus.hasConsent[e],updateConsentStatus:e=>{if(!e)return;const t=f.hasStorageConsent;f.consentStatus=Object.assign({},f.consentStatus,e),f.hasStorageConsent=h(f.consentStatus),e.hasConsent&&(void 0!==e.hasConsent.analytics&&w("consent_analytics",e.hasConsent.analytics),void 0!==e.hasConsent.advertising&&w("consent_advertising",e.hasConsent.advertising),void 0!==e.hasConsent.personalization&&w("consent_personalization",e.hasConsent.personalization)),e.framework&&w("consent_framework",e.framework),void 0!==e.gdprApplies&&w("gdpr_applies",e.gdprApplies),f.payloadData.non_personalized_ads=f.hasStorageConsent?0:1,!t&&f.hasStorageConsent&&"browser"===f.mode&&(f.payloadData.client_id&&(u.cookies.set("_attrib_cid",f.payloadData.client_id,365,!0),u.localStorage.set("_attrib_cid",f.payloadData.client_id,!0)),u.cookies.set("_attrib_sid",f.payloadData.session_id,0,!0),u.cookies.set("_attrib_last",r().toString(),0,!0),u.localStorage.set("_attrib_snum",f.payloadData.session_number.toString(),!0),f.payloadData.user_id&&u.localStorage.set("_attrib_uid",f.payloadData.user_id,!0),f.useServiceWorker&&(m=p.register(f.swPath,!0)),f.offlineStorage&&"addEventListener"in window&&(window.addEventListener("online",b),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&b()})),window.addEventListener("beforeunload",(()=>{if(f.queue.length>0)for(const e of f.queue)y(e.eventName,e.eventParameters,f.endpoint,e.payload)})))),t&&!f.hasStorageConsent&&"browser"===f.mode&&(u.cookies.delete("_attrib_cid"),u.cookies.delete("_attrib_sid"),u.cookies.delete("_attrib_last"))},hasStorageConsent:()=>f.hasStorageConsent,ConsentTypes:g.ConsentTypes};return"undefined"!=typeof window&&(window._attributionCoreInstance=S),S},_=()=>{if("undefined"==typeof window)return;const e=window._attributionCoreQueue||[];if(!Array.isArray(e))return;let t=window._attributionCoreInstance;e.forEach((e=>{if(!Array.isArray(e))return;const o=[...e],n=o.shift();if(n)t&&"function"==typeof t[n]&&t[n](...o);else if(o.length>0&&!t){const e=o[0],n=o[1]||{};t=f(e,n),window._attributionCoreInstance=t}})),window._attributionCoreQueue=[],window.AttributionCore=function(){const e=Array.from(arguments);if(0===e.length)return t;if("string"==typeof e[0]&&(!e[1]||"object"!=typeof e[1]||Array.isArray(e[1]))){const o=e[0],n=e.slice(1);return"function"==typeof t[o]?t[o](...n):null}return t}};if("undefined"!=typeof window){window._attributionCoreQueue&&!window._attributionCoreInstance&&_();const e=f;window.AttributionCore=function(){const t=Array.from(arguments);if(window._attributionCoreInstance){if("string"==typeof t[0]){const e=t[0],o=t.slice(1);return"function"==typeof window._attributionCoreInstance[e]?window._attributionCoreInstance[e](...o):null}return window._attributionCoreInstance}const o=e(...t);return _(),o}}const m=f;return t=t.default})()));