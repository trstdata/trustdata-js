(()=>{const e="attribution_core_queue";const t=(...e)=>{false};async function s(e,s){try{const r=await n();return r.events.push({endpoint:e,payload:s,timestamp:Date.now(),retries:0}),await a(r),t(),!0}catch(e){return t(),!1}}async function n(){try{const s=(await r()).transaction(["events"],"readonly"),n=s.objectStore("events").get(e);return new Promise(((e,s)=>{n.onsuccess=()=>{const t=n.result||{events:[]};e(t)},n.onerror=()=>{t(n.error),s(n.error)}}))}catch(e){return t(),{events:[]}}}async function a(s){try{const n=(await r()).transaction(["events"],"readwrite"),a=n.objectStore("events").put(s,e);return new Promise(((e,s)=>{a.onsuccess=()=>{e(!0)},a.onerror=()=>{t(a.error),s(a.error)}}))}catch(e){return t(),!1}}function r(){return new Promise(((e,s)=>{const n=indexedDB.open("AttributionCoreDB",1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("events")||t.createObjectStore("events")},n.onsuccess=t=>{const s=t.target.result;e(s)},n.onerror=e=>{t(n.error),s(n.error)}}))}async function o(){try{const e=await n();if(!e.events||0===e.events.length)return 0;t(e.events.length);let s=0;const r=[];for(const n of e.events)if(n.retries>=5)t();else try{await c(n.endpoint,n.payload)?s++:(n.retries++,r.push(n))}catch(e){n.retries++,r.push(n)}return e.events=r,await a(e),t(r.length),s}catch(e){return t(),0}}async function c(e,s){try{const t=Object.entries(s).map((([e,t])=>Array.isArray(t)?t.map((t=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&"):`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&");await fetch(`${e}?${t}`,{method:"POST",mode:"no-cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"text/plain;charset=UTF-8"},referrerPolicy:"no-referrer",body:""});return!0}catch(e){return t(),!1}}self.addEventListener("install",(e=>{t(),e.waitUntil(self.skipWaiting())})),self.addEventListener("activate",(e=>{t(),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if("attribution-core-cache-v1"!==e)return caches.delete(e)}))))).then((()=>self.clients.claim())))})),self.addEventListener("sync",(e=>{"attribution-core-sync"===e.tag&&(t(),e.waitUntil(o()))})),self.addEventListener("message",(e=>{t(e.data);const{action:r,messageId:i}=e.data||{};r&&("recordEvent"===r?e.waitUntil(async function(e){const{endpoint:n,payload:a,messageId:r}=e.data;try{if(!(self.navigator?.onLine??1))return await s(n,a),{messageId:r,success:!1,queued:!0,offline:!0,timestamp:Date.now()};try{return await c(n,a)?{messageId:r,success:!0,timestamp:Date.now()}:(await s(n,a),{messageId:r,success:!1,queued:!0,timestamp:Date.now()})}catch(e){return await s(n,a),{messageId:r,success:!1,queued:!0,error:e.message,timestamp:Date.now()}}}catch(e){return t(),{messageId:r,success:!1,queued:!1,error:e.message,timestamp:Date.now()}}}(e).then((t=>{e.source&&e.source.postMessage(t)}))):"processQueue"===r?e.waitUntil(o().then((t=>{e.source&&e.source.postMessage({messageId:i,action:"processQueueResult",processedCount:t,timestamp:Date.now()})}))):"getQueueStatus"===r?e.waitUntil(n().then((t=>{e.source&&e.source.postMessage({messageId:i,action:"queueStatus",count:t.events?t.events.length:0,timestamp:Date.now()})}))):"clearQueue"===r?e.waitUntil(a({events:[]}).then((()=>{e.source&&e.source.postMessage({messageId:i,action:"queueCleared",success:!0,timestamp:Date.now()})}))):"ping"===r&&e.source&&e.source.postMessage({messageId:i,action:"pong",timestamp:Date.now()}))})),self.addEventListener("fetch",(e=>{const t=new URL(e.request.url);if("/g/collect"===t.pathname&&("www.google-analytics.com"===t.hostname||"analytics.google.com"===t.hostname)){const n=e.request.clone();e.respondWith(fetch(e.request.clone()).catch((e=>n.text().then((e=>{const n=t.origin+t.pathname,a={};for(const[e,s]of t.searchParams.entries())a[e]=s;return s(n,a),new Response("",{status:200,statusText:"OK"})})))))}})),self.addEventListener("periodicsync",(e=>{"attribution-core-sync"===e.tag&&(t(),e.waitUntil(o()))})),self.addEventListener("push",(e=>{if(e.data){"process-queue"===e.data.json().action&&(t(),e.waitUntil(o()))}})),self.addEventListener("activate",(e=>{e.waitUntil(Promise.all([void("sync"in self.registration&&self.registration.sync.register("attribution-core-sync").then((()=>{t()})).catch((e=>{t()}))),void("periodicSync"in self.registration&&self.registration.periodicSync.register("attribution-core-sync",{minInterval:108e5}).then((()=>{t()})).catch((e=>{t()}))),self.clients.claim()]))})),self.addEventListener("install",(e=>{t(),e.waitUntil(Promise.all([self.skipWaiting(),n().then((e=>{if(e.events&&e.events.length>0){const t=Date.now()-12096e5;return e.events=e.events.filter((e=>e.timestamp>t)),a(e)}}))]))}))})();